<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Loser&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Loser's Blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Loser's Blog">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Loser's Blog">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="Loser&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Loser&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-cocos2d-lua-binding" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/08/cocos2d-lua-binding/" class="article-date">
  <time datetime="2016-07-08T11:41:11.000Z" itemprop="datePublished">2016-07-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/08/cocos2d-lua-binding/">Cocos2d-lua绑定自定义c++类</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近在使用cocos2d-lua写一些小游戏，遇到了需要在lua中调用自定义的c++类的情况，于是花了一下午时间来踩这个坑，目前终于成功跑起来了，故在此做一个记录。</p>
<ul>
<li><h4 id="lua_u8C03_u7528_u9759_u6001c++_u51FD_u6570"><a href="#lua_u8C03_u7528_u9759_u6001c++_u51FD_u6570" class="headerlink" title="lua调用静态c++函数"></a>lua调用静态c++函数</h4>在lua中调用c++有很多中办法，例如可以直接使用lua_register来注册一个静态函数。如下：  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;lua.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;lualib.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;lauxlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">test</span><span class="params">(lua_State *L)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> n = lua_tonumber(L, <span class="number">1</span>);</span><br><span class="line">  lua_pushnumber(L, n + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  lua_State *L = lua_open();</span><br><span class="line">  luaL_openlibs(L);</span><br><span class="line">  lua_register(L, <span class="string">"test"</span>, test);</span><br><span class="line">  luaL_dofile(L, <span class="string">"a.lua"</span>);</span><br><span class="line">  lua_close(L);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>在test函数中，lua_tonumber(L, 1)获取了L环境中给test输入的第一个参数，因为lua与c++的交互是通过一个栈来进行的，所以函数返回之前使用了lua_pushnumber来向栈中压入一个值。注意在lua中函数返回的可以不止一个值，所以在这里也可以多次push，最后test的return值意味着此函数一共返回了多少个值。<br>test函数定义好之后，通过lua_register向lua环境注册这个函数，这样在lua代码中就可以对此函数进行调用了。<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(test(<span class="number">1</span>))</span><br></pre></td></tr></table></figure></p>
<ul>
<li><h4 id="lua_u8C03_u7528_u81EA_u5B9A_u4E49c++_u7C7B"><a href="#lua_u8C03_u7528_u81EA_u5B9A_u4E49c++_u7C7B" class="headerlink" title="lua调用自定义c++类"></a>lua调用自定义c++类</h4>因为在实际使用中不可能只使用到静态函数，还要经常使用自己定义的c++类，如果直接使用类似于lua_register的方式来注册c++类，那么工作量会非常大。这时候可以使用类似于tolua++之类的第三方工具来进行注册，但是这里不再赘述，就直接讲如何使用cocos2d自带的bindings-generator工具进行注册。  <h5 id="u5B9E_u73B0_u6240_u9700_u7684c++_u7C7B"><a href="#u5B9E_u73B0_u6240_u9700_u7684c++_u7C7B" class="headerlink" title="实现所需的c++类"></a>实现所需的c++类</h5>首先给出一个示例用的c++类：  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MyClass.h</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">"cocos2d.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cocos2d;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> MyClass : <span class="keyword">public</span> Ref &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    MyClass() &#123;&#125;</span><br><span class="line">    ~MyClass() &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    CREATE_FUNC(MyClass);</span><br><span class="line">    <span class="comment">// used to test</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">test</span><span class="params">(<span class="keyword">int</span> i)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MyClass.cpp</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">"MyClass.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> MyClass::test(<span class="keyword">int</span> i) &#123;</span><br><span class="line">  <span class="keyword">return</span> i + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里应该注意一点，就是在cocos2d中的自定义类应当继承ref或者其子类，因为这样可以让cocos2d将内存管理起来，不需要自己来操心。<br>如果lua工程目录为LuaTest/，则将c++类的两个文件放到LuaTest/frameworks/runtime-src/Classes/下面，因为新添加这两个文件，所以也要记得修改对应的makefile，例如我是在linux上进行测试的，则修改CMakeList.txt，将参加编译的文件修改为：<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(GAME_SRC</span><br><span class="line">  runtime-src/proj.linux/main.cpp</span><br><span class="line">  runtime-src/Classes/AppDelegate.cpp</span><br><span class="line">  runtime-src/Classes/MyClass.cpp</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>即添加了刚刚创建的MyClass。如果是其它平台，例如android，则修改对应的Android.mk，如果是xcode的工程，则需要将文件拖入工程。  </p>
<h5 id="u521B_u5EFA_u914D_u7F6E_u6587_u4EF6_uFF0C_u5E76_u4F7F_u7528_u811A_u672C_u751F_u6210_u6CE8_u518C_u7528c++_u6587_u4EF6"><a href="#u521B_u5EFA_u914D_u7F6E_u6587_u4EF6_uFF0C_u5E76_u4F7F_u7528_u811A_u672C_u751F_u6210_u6CE8_u518C_u7528c++_u6587_u4EF6" class="headerlink" title="创建配置文件，并使用脚本生成注册用c++文件"></a>创建配置文件，并使用脚本生成注册用c++文件</h5><p>接下来，需要使用bindings-generator来自动生成一个用于注册的c++文件。此时切换目录到LuaTest/frameworks/cocos2d-x/tools/tolua/下，<br>可以看到这里有很多.ini文件，以及一个genbindings.py文件。<br>.ini文件定义了从c++文件生成用于注册的c++文件的规则，而genbindings.py则是cocos2d提供的脚本，可以根据ini规则生成用于注册的c++文件。</p>
<p>为了注册MyClass文件，简单的话可以直接复制一个ini文件，例如cocos2dx.ini，然后对其进行修改，重点要修改的内容为：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[MyClass]</span></span><br><span class="line"><span class="setting">prefix           = <span class="value">MyClass</span></span></span><br><span class="line"><span class="setting">target_namespace = <span class="value">custom</span></span></span><br><span class="line"><span class="setting">headers          = <span class="value">%(cocosdir)s/../runtime-src/Classes/MyClass.h</span></span></span><br><span class="line"><span class="setting">classes          = <span class="value">MyClass</span></span></span><br></pre></td></tr></table></figure></p>
<p>其中target_namespace为命名空间，例如cocos2d在lua中的命名空间就为cc。headers指向我们一开始创建的原始c++文件，classes中可以声明多个类，用空格隔开；因为我们的文件中只有MyClass一个类，所以这里就只写MyClass了。<br>修改完，命名为MyClass.ini保存。<br>然后是对脚本进行修改。其实可以直接修改genbindings.py，但是因为其中涉及到太多文件，每次运行的时间可能会太长，所以这里又拷贝一份，命名为genbindings_custom.py。<br>打开文件，在141行左右，修改：<br><figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cmd_args = &#123;<span class="symbol">'cocos2dx</span>.ini' : (<span class="symbol">'cocos2d</span>-x', <span class="symbol">'lua_cocos2dx_auto'</span>), \</span><br><span class="line">            <span class="symbol">'cocos2dx_extension</span>.ini' : (<span class="symbol">'cocos2dx_extension'</span>, <span class="symbol">'lua_cocos2dx_extension_auto'</span>), \</span><br><span class="line">            <span class="symbol">'cocos2dx_ui</span>.ini' : (<span class="symbol">'cocos2dx_ui'</span>, <span class="symbol">'lua_cocos2dx_ui_auto'</span>), \</span><br><span class="line">            <span class="symbol">'cocos2dx_studio</span>.ini' : (<span class="symbol">'cocos2dx_studio'</span>, <span class="symbol">'lua_cocos2dx_studio_auto'</span>), \</span><br><span class="line">            <span class="symbol">'cocos2dx_spine</span>.ini' : (<span class="symbol">'cocos2dx_spine'</span>, <span class="symbol">'lua_cocos2dx_spine_auto'</span>), \</span><br><span class="line">            <span class="symbol">'cocos2dx_physics</span>.ini' : (<span class="symbol">'cocos2dx_physics'</span>, <span class="symbol">'lua_cocos2dx_physics_auto'</span>), \</span><br><span class="line">            <span class="symbol">'cocos2dx_experimental_video</span>.ini' : (<span class="symbol">'cocos2dx_experimental_video'</span>, <span class="symbol">'lua_cocos2dx_experimental_video_auto'</span>), \</span><br><span class="line">            <span class="symbol">'cocos2dx_experimental</span>.ini' : (<span class="symbol">'cocos2dx_experimental'</span>, <span class="symbol">'lua_cocos2dx_experimental_auto'</span>), \</span><br><span class="line">            <span class="symbol">'cocos2dx_controller</span>.ini' : (<span class="symbol">'cocos2dx_controller'</span>, <span class="symbol">'lua_cocos2dx_controller_auto'</span>), \</span><br><span class="line">            <span class="symbol">'cocos2dx_cocosbuilder</span>.ini': (<span class="symbol">'cocos2dx_cocosbuilder'</span>, <span class="symbol">'lua_cocos2dx_cocosbuilder_auto'</span>), \</span><br><span class="line">            <span class="symbol">'cocos2dx_cocosdenshion</span>.ini': (<span class="symbol">'cocos2dx_cocosdenshion'</span>, <span class="symbol">'lua_cocos2dx_cocosdenshion_auto'</span>), \</span><br><span class="line">            <span class="symbol">'cocos2dx_3d</span>.ini': (<span class="symbol">'cocos2dx_3d'</span>, <span class="symbol">'lua_cocos2dx_3d_auto'</span>), \</span><br><span class="line">            <span class="symbol">'cocos2dx_audioengine</span>.ini': (<span class="symbol">'cocos2dx_audioengine'</span>, <span class="symbol">'lua_cocos2dx_audioengine_auto'</span>), \</span><br><span class="line">            <span class="symbol">'cocos2dx_csloader</span>.ini' : (<span class="symbol">'cocos2dx_csloader'</span>, <span class="symbol">'lua_cocos2dx_csloader_auto'</span>), \</span><br><span class="line">            <span class="symbol">'cocos2dx_experimental_webview</span>.ini' : (<span class="symbol">'cocos2dx_experimental_webview'</span>, <span class="symbol">'lua_cocos2dx_experimental_webview_auto'</span>), \</span><br><span class="line">            <span class="symbol">'cocos2dx_physics3d</span>.ini' : (<span class="symbol">'cocos2dx_physics3d'</span>, <span class="symbol">'lua_cocos2dx_physics3d_auto'</span>), \</span><br><span class="line">            <span class="symbol">'cocos2dx_navmesh</span>.ini' : (<span class="symbol">'cocos2dx_navmesh'</span>, <span class="symbol">'lua_cocos2dx_navmesh_auto'</span>), \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>为：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="setting">cmd_args = <span class="value">&#123;<span class="string">'MyClass.ini'</span> : (<span class="string">'MyClass'</span>, <span class="string">"lua_customclass_auto"</span>)&#125;</span></span></span><br></pre></td></tr></table></figure></p>
<p>其意义就是根据MyClass.ini文件自动生成用于注册的lua_customclass_auto.cpp以及.hpp文件。修改完后保存退出。在命令行切换到这个目录，然后运行脚本：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$python genbindings_custom.py</span><br></pre></td></tr></table></figure></p>
<p>这里可能碰到一个坑，要注意一下，就是，运行脚本可能会出现这样的错误：<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">====</span><br><span class="line">Errors in parsing headers:</span><br><span class="line">1. &lt;severity = Fatal,</span><br><span class="line">    location = &lt;SourceLocation file '/home/xxx/NDK/platforms/android-14/arch-arm/usr/include/android/log.h', line 70, column 10&gt;,</span><br><span class="line">    details = "'stdarg.h' file not found"&gt;</span><br><span class="line">====</span><br></pre></td></tr></table></figure></p>
<p>这个错误的原因是genbindings_custom.py脚本与ndk不兼容的问题，因为找不的ndk中的llvm-3.3文件夹，如果出现这个错误，先查看自己ndk目录的toolchains文件夹，看看自己是什么版本的llvm。我这里有llvm-3.5和llvm-3.6两个相关的文件夹，而在genbindings_custom.py脚本中有这么一段：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="string">'3.4'</span> <span class="keyword">in</span> llvm_path:</span><br><span class="line">    config.<span class="function"><span class="title">set</span><span class="params">(<span class="string">'DEFAULT'</span>, <span class="string">'clang_version'</span>, <span class="string">'3.4'</span>)</span></span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    config.<span class="function"><span class="title">set</span><span class="params">(<span class="string">'DEFAULT'</span>, <span class="string">'clang_version'</span>, <span class="string">'3.3'</span>)</span></span></span><br></pre></td></tr></table></figure></p>
<p>这一段应该是用于处理早期的ndk的脚本，我的ndk应该比较新，在这里不适用，所以应该进行修改。为了偷懒，我直接将3.3改为了3.5：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="string">'3.4'</span> <span class="keyword">in</span> llvm_path:</span><br><span class="line">    config.<span class="function"><span class="title">set</span><span class="params">(<span class="string">'DEFAULT'</span>, <span class="string">'clang_version'</span>, <span class="string">'3.4'</span>)</span></span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    config.<span class="function"><span class="title">set</span><span class="params">(<span class="string">'DEFAULT'</span>, <span class="string">'clang_version'</span>, <span class="string">'3.5'</span>)</span></span></span><br></pre></td></tr></table></figure></p>
<p>运行脚本，现在显示成功生成了：<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">---------------------------------</span><br><span class="line">Generating lua bindings succeeds.</span><br><span class="line">---------------------------------</span></span><br></pre></td></tr></table></figure></p>
<h5 id="u5728AppDelegate-cpp_u4E2D_u6CE8_u518C_u81EA_u5B9A_u4E49_u7684c++_u7C7B"><a href="#u5728AppDelegate-cpp_u4E2D_u6CE8_u518C_u81EA_u5B9A_u4E49_u7684c++_u7C7B" class="headerlink" title="在AppDelegate.cpp中注册自定义的c++类"></a>在AppDelegate.cpp中注册自定义的c++类</h5><p>自动生成的cpp文件在LuaTest/frameworks/cocos2d-x/cocos/scripting/lua-bindings/auto/路径下，因为我们之前在脚本中设置的名字为lua_customclass_auto，所以在这里可以找到lua_customclass_auto.cpp，lua_customclass_auto.hpp两个文件。<br>将这两个文件拷贝到MyClass.cpp所在路径下，并且同样的在makefile中添加lua_customclass_auto.cpp文件。例如我的Linux的设置是修改CMakeList.txt：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">set(GAME_SRC</span><br><span class="line">  <span class="keyword">runtime</span>-src<span class="regexp">/proj.linux/m</span>ain.cpp</span><br><span class="line">  <span class="keyword">runtime</span>-src<span class="regexp">/Classes/</span>AppDelegate.cpp</span><br><span class="line">  <span class="keyword">runtime</span>-src<span class="regexp">/Classes/My</span><span class="keyword">Class</span>.cpp</span><br><span class="line">  <span class="keyword">runtime</span>-src<span class="regexp">/Classes/</span>lua_customclass_auto.cpp</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>生成的lua_customclass_auto文件就是脚本读取MyClass后根据其内容自动生成的用于注册的文件，打开lua_customclass_auto.hpp可以看到：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">"base/ccConfig.h"</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifndef</span> __MyClass_h__</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> __MyClass_h__</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">"tolua++.h"</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_all_MyClass</span><span class="params">(lua_State* tolua_S)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span> <span class="comment">// __MyClass_h__</span></span></span><br></pre></td></tr></table></figure></p>
<p>这里有一个register_all_MyClass方法，调用这个方法就可以向lua注册我们自定义的c++类。所以最后，打开AppDelegate.cpp，找到lua注册相关的代码，修改为：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// register lua module</span></span><br><span class="line"><span class="keyword">auto</span> engine = LuaEngine::getInstance();</span><br><span class="line">ScriptEngineManager::getInstance()-&gt;setScriptEngine(engine);</span><br><span class="line">lua_State* L = engine-&gt;getLuaStack()-&gt;getLuaState();</span><br><span class="line">lua_module_register(L);</span><br><span class="line"></span><br><span class="line">register_all_packages();</span><br><span class="line"></span><br><span class="line">LuaStack* <span class="built_in">stack</span> = engine-&gt;getLuaStack();</span><br><span class="line"><span class="built_in">stack</span>-&gt;setXXTEAKeyAndSign(<span class="string">"2dxLua"</span>, <span class="built_in">strlen</span>(<span class="string">"2dxLua"</span>), <span class="string">"XXTEA"</span>, <span class="built_in">strlen</span>(<span class="string">"XXTEA"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//register custom function</span></span><br><span class="line"><span class="comment">//LuaStack* stack = engine-&gt;getLuaStack();</span></span><br><span class="line"><span class="comment">//register_custom_function(stack-&gt;getLuaState());</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里注册自定义的c++类</span></span><br><span class="line">register_all_MyClass(<span class="built_in">stack</span>-&gt;getLuaState());</span><br></pre></td></tr></table></figure></p>
<p>并且记得在AppDelegate.cpp中include一下lua_customclass_auto.hpp文件，不然没法访问到register_all_MyClass函数。</p>
<p>最后，在lua代码中进行测试：<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> customClass = custom.MyClass:create()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"lua bind: "</span>..customClass:test(<span class="number">100</span>))</span><br></pre></td></tr></table></figure></p>
<p>没错误的话就成功啦。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/07/08/cocos2d-lua-binding/" data-id="ciy30454t00003gcp87ym55ap" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cocos2d/">cocos2d</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- 
 -->


  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
    </nav>
  
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/chipmunk/">chipmunk</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cocos2d/">cocos2d</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gamedesign/">gamedesign</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tilemap/">tilemap</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/物理引擎/">物理引擎</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/chipmunk/" style="font-size: 10px;">chipmunk</a> <a href="/tags/cocos2d/" style="font-size: 20px;">cocos2d</a> <a href="/tags/gamedesign/" style="font-size: 10px;">gamedesign</a> <a href="/tags/tilemap/" style="font-size: 15px;">tilemap</a> <a href="/tags/物理引擎/" style="font-size: 10px;">物理引擎</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/01/18/gamedesign-psychology/">&quot;游戏心理学&quot;相关笔记</a>
          </li>
        
          <li>
            <a href="/2016/07/08/cocos2d-lua-binding/">Cocos2d-lua绑定自定义c++类</a>
          </li>
        
          <li>
            <a href="/2016/04/13/cocos2d-render/">Cocos2dx:绘制流程</a>
          </li>
        
          <li>
            <a href="/2016/03/27/cocos2d-tilemap02/">Cocos2dx:TileMap的使用（二）</a>
          </li>
        
          <li>
            <a href="/2016/03/26/cocos2d-tilemap01/">Cocos2dx:TileMap的使用（一）</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 KJTang<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>